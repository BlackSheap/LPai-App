"use strict";(()=>{var e={};e.id=589,e.ids=[589],e.modules={1428:e=>{e.exports=import("axios")},2485:(e,t,o)=>{o.a(e,async(e,n)=>{try{o.r(t),o.d(t,{config:()=>d,default:()=>l,routeModule:()=>p});var r=o(3480),a=o(8667),i=o(6435),s=o(4578),c=e([s]);s=(c.then?(await c)():c)[0];let l=(0,i.M)(s,"default"),d=(0,i.M)(s,"config"),p=new r.PagesAPIRouteModule({definition:{kind:a.A.PAGES_API,page:"/api/projects",pathname:"/api/projects",bundlePath:"",filename:""},userland:s});n()}catch(e){n(e)}})},2518:e=>{e.exports=require("mongodb")},3480:(e,t,o)=>{e.exports=o(5600)},4578:(e,t,o)=>{o.a(e,async(e,n)=>{try{o.r(t),o.d(t,{default:()=>c});var r=o(9194),a=o(2518),i=o(1428),s=e([i]);async function c(e,t){let o=(await r.A).db("lpai");if("GET"===e.method)try{let n=e.query.locationId;if(!n)return t.status(403).json({error:"Missing locationId"});let r=await o.collection("projects").find({locationId:n}).sort({createdAt:-1}).toArray(),i=r.map(e=>e.contactId).filter(Boolean),s=await o.collection("contacts").find({_id:{$in:i.map(e=>new a.ObjectId(e))}}).toArray(),c=Object.fromEntries(s.map(e=>[e._id.toString(),{name:`${e.firstName} ${e.lastName}`,email:e.email,phone:e.phone||""}])),l=r.map(e=>{let t=c[e.contactId?.toString()];return{...e,contactName:t?.name||"—",contactEmail:t?.email||"",contactPhone:t?.phone||""}});t.status(200).json(l)}catch(e){console.error("❌ Failed to load all projects:",e),t.status(500).json({error:"Internal server error"})}else if("POST"!==e.method)return t.setHeader("Allow",["GET","POST"]),t.status(405).json({error:"Method not allowed"});else try{let n,{contactId:r,userId:s,locationId:c,title:l,status:d,...p}=e.body;if(!r||!s||!c||!l)return t.status(400).json({error:"Missing required fields"});let u={contactId:r,userId:s,locationId:c,title:l,status:d,...p,createdAt:new Date},f=await o.collection("projects").insertOne(u);try{let e=await o.collection("contacts").findOne({_id:new a.ObjectId(r)}),t=e?.ghlContactId,s=await o.collection("locations").findOne({locationId:c}),d=s?.apiKey,u=p.pipelineId;if(d&&t&&u){let e={contactId:t,pipelineId:u,locationId:c,status:"open",name:l};console.log("\uD83D\uDE80 GHL Opportunity payload:",e);let r=await i.default.post("https://services.leadconnectorhq.com/opportunities/",e,{headers:{Authorization:`Bearer ${d}`,"Content-Type":"application/json",Version:"2021-07-28"}});n=r.data.opportunity?.id,console.log("✅ GHL Opportunity created:",n),n&&await o.collection("projects").updateOne({_id:f.insertedId},{$set:{ghlOpportunityId:n}})}else console.warn("⚠️ Missing GHL info (apiKey, ghlContactId, pipelineId), skipping GHL sync."),console.log({apiKey:d,ghlContactId:t,pipelineId:u})}catch(e){console.error("❌ Failed to sync opportunity with GHL:",e.response?.data||e.message)}return t.status(201).json({success:!0,projectId:f.insertedId,ghlOpportunityId:n})}catch(e){console.error("❌ Failed to create project:",e),t.status(500).json({error:"Failed to create project"})}}i=(s.then?(await s)():s)[0],n()}catch(e){n(e)}})},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6435:(e,t)=>{Object.defineProperty(t,"M",{enumerable:!0,get:function(){return function e(t,o){return o in t?t[o]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,o)):"function"==typeof t&&"default"===o?t:void 0}}})},8667:(e,t)=>{Object.defineProperty(t,"A",{enumerable:!0,get:function(){return o}});var o=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})},9194:(e,t,o)=>{o.d(t,{A:()=>a});var n=o(2518);let r=process.env.MONGODB_URI;if(!r)throw Error("⚠️ MONGODB_URI is missing in environment variables");let a=new n.MongoClient(r,{}).connect()}};var t=require("../../webpack-api-runtime.js");t.C(e);var o=t(t.s=2485);module.exports=o})();